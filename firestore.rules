rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for reusable logic
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Checks if the requesting user has the 'admin' role in their user document.
    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }


    /**
     * @description Controls access to the 'caves' collection. All users can read cave data, but only admins can modify it.
     */
    match /caves/{caveId} {
      allow get, list: if true;
      allow write: if isAdmin();

      /**
       * @description Controls access to the 'spots' subcollection. All users can read spots, but only admins can modify them.
       */
      match /spots/{spotId} {
        allow get, list: if true;
        allow create: if isAdmin() && request.resource.data.caveId == caveId;
        allow update: if isAdmin() && resource != null && request.resource.data.caveId == resource.data.caveId;
        allow delete: if isAdmin() && resource != null;
      }
    }
    
    /**
     * @description Allow admins to list all spots for the admin panel.
     */
    match /spots/{spotId} {
        allow get, list: if isAdmin();
    }

    /**
     * @description Controls access to user documents. Users can only manage their own data.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.role) || isAdmin();
      allow delete: if false;
    }

    /**
     * @description Public read for kiosk settings, admin write.
     */
    match /kioskSettings/{settingId} {
      allow get, list: if true;
      allow write: if isAdmin();
    }
    
    /**
     * @description Kiosk devices can write their own heartbeat. Admin can read all.
     */
    match /kioskDevices/{deviceId} {
      allow read: if isAdmin();
      allow write: if true; // Allow any device to write its heartbeat
    }

    /**
     * @description Kiosk control is read by devices, written by admin.
     */
    match /kioskControl/{controlId} {
        allow read: if true;
        allow write: if isAdmin();
    }

    /**
     * @description Any device can write kiosk events.
     */
    match /kioskEvents/{eventId} {
        allow create: if true;
        allow read, update, delete: if false;
    }
  }
}
