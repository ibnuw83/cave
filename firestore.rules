rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      // Ambil dokumen pengguna yang melakukan request dan periksa field 'role'.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /locations/{locationId} {
      /**
       * Kontrol akses ke koleksi 'locations'.
       * Semua pengguna dapat membaca data lokasi, tetapi hanya admin yang dapat memodifikasinya.
       */
      allow get, list: if true;
      allow write: if isAdmin();
    }
    
    match /spots/{spotId} {
        /**
         * Kontrol akses ke koleksi global 'spots'.
         * Semua pengguna dapat membaca spot, tetapi hanya admin yang dapat membuat, memperbarui, atau menghapusnya.
         */
        allow get, list: if true;
        allow write: if isAdmin();
    }

    match /users/{userId} {
      /**
       * Kontrol akses ke dokumen pengguna.
       * Pengguna hanya dapat mengelola datanya sendiri. Admin memiliki akses penuh.
       */
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      // Pengguna biasa tidak bisa mengubah role-nya sendiri, tapi admin bisa.
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.role) || isAdmin();
      allow delete: if isAdmin(); // Hanya admin yang bisa menghapus user.
    }

    match /kioskSettings/{settingId} {
      /**
       * Pengaturan kios dapat dibaca publik, ditulis oleh admin.
       */
      allow get, list: if true;
      allow write: if isAdmin();
    }
    
    match /kioskDevices/{deviceId} {
      /**
       * Perangkat kios dapat menulis heartbeat-nya sendiri. Admin dapat membaca semua.
       */
      allow read: if isAdmin();
      allow write: if true; // Perangkat mengirim heartbeat tanpa otentikasi
    }

    match /kioskControl/{controlId} {
        /**
         * Kontrol kios dibaca oleh perangkat, ditulis oleh admin.
         */
        allow read: if true;
        allow write: if isAdmin();
    }

    match /kioskEvents/{eventId} {
        /**
         * Perangkat apa pun dapat menulis event kios. Tidak bisa dibaca/update/delete.
         */
        allow create: if true;
        allow read, update, delete: if false;
    }

    match /pricingTiers/{tierId} {
      /**
       * Paket harga dapat dibaca publik, ditulis oleh admin.
       */
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
