
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Aturan Sederhana: Baca publik, Tulis via server backend yang diautentikasi

    // Siapa pun dapat membaca data lokasi dan spot.
    // Ini penting untuk pengguna anonim dan SEO.
    match /locations/{locationId} {
      allow get, list: if true;
      // HANYA admin yang bisa menulis (create, update, delete)
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    match /spots/{spotId} {
      allow get, list: if true;
       // HANYA admin yang bisa menulis (create, update, delete)
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Aturan untuk profil pengguna.
    match /users/{userId} {
      // Siapa pun dapat membaca profil pengguna lain (jika diperlukan untuk fitur publik).
      allow get: if true;
      
      // Hanya admin (melalui backend) yang dapat melihat daftar semua pengguna.
      allow list: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Pengguna dapat membuat dokumen mereka sendiri saat mendaftar.
      // Admin (melalui backend) juga bisa membuat pengguna.
      allow create: if request.auth != null;

      // Pengguna dapat memperbarui dokumen mereka sendiri.
      // Admin (melalui backend) juga bisa memperbarui dokumen apa pun.
      allow update: if request.auth != null && (request.auth.uid == userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      // Hanya admin (melalui backend) yang dapat menghapus pengguna.
      allow delete: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Pengaturan kios hanya dapat ditulis dari backend admin.
    match /kioskSettings/{settingId} {
      allow get, list: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    // Perangkat kios dapat menulis heartbeat-nya.
    // Aturan ini permisif karena perangkat mungkin tidak diautentikasi.
    match /kioskDevices/{deviceId} {
      allow read: if true; // Diperlukan untuk dibaca oleh backend admin
      allow write: if true;
    }

    // Perangkat kios membaca kontrol, admin menulisnya.
    match /kioskControl/{controlId} {
        allow read: if true;
        allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Siapa pun (terutama kios) dapat membuat event.
    match /kioskEvents/{eventId} {
        allow create: if true;
        allow read, update, delete: if false; // Event tidak dapat dibaca atau diubah
    }

    // Paket harga dapat dibaca publik, ditulis oleh backend admin.
    match /pricingTiers/{tierId} {
      allow get, list: if true;
      allow write: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Statistik Kios ditulis oleh kios.
    match /kioskStats/{locationId} {
      allow read: if true;
      allow write: if true; // Diperbarui oleh kios
    }
  }
}
