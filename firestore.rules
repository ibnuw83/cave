rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    match /locations/{locationId} {
      /**
       * @description Controls access to the 'locations' collection. All signed-in users can read location data, but only admins can modify it.
       */
      allow get, list: if isSignedIn();
      allow write: if isAdmin();
    }
    
    match /spots/{spotId} {
        /**
         * @description Controls access to the global 'spots' collection.
         * All users can read spots, but only admins can create, update, or delete them.
         */
        allow get, list: if true;
        allow write: if isAdmin();
    }

    match /users/{userId} {
      /**
       * @description Controls access to user documents. Users can only manage their own data.
       */
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId);
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.role) || isAdmin();
      allow delete: if false;
    }

    match /kioskSettings/{settingId} {
      /**
       * @description Public read for kiosk settings, admin write.
       */
      allow get, list: if true;
      allow write: if isAdmin();
    }
    
    match /kioskDevices/{deviceId} {
      /**
       * @description Kiosk devices can write their own heartbeat. Admin can read all.
       */
      allow read: if isAdmin();
      allow write: if true;
    }

    match /kioskControl/{controlId} {
        /**
         * @description Kiosk control is read by devices, written by admin.
         */
        allow read: if true;
        allow write: if isAdmin();
    }

    match /kioskEvents/{eventId} {
        /**
         * @description Any device can write kiosk events.
         */
        allow create: if true;
        allow read, update, delete: if false;
    }

    match /pricingTiers/{tierId} {
      /**
       * @description Public read for pricing tiers, admin write.
       */
      allow get, list: if true;
      allow create, update, delete: if isAdmin();
    }
  }
}
